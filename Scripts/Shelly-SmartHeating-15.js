// Thank you for your support: www.buymeacoffee.com/spothintafi
// Supported Shelly firmwares: 1.4.4 - 1.7.1. Script version: 2025-11-08

// SmartHeating: outdoor temperature controlled heating with a possibility to control multiple relays with the same rules.
// Note! Temperature forecast is based on YR.NO service. Please take into account, that accuracy of the forecast may vary.     

// Modify these settings
let SETTINGS =
{
    // Region
    Region: "FI", // Supported regions: DK1, DK2, EE, FI, LT, LV, NO1, NO2, NO3, NO4, NO5, SE1, SE2, SE3, SE4

    // Relay settings
    RelayName: "Sleeping room and livingroom",  // Name for this configuration. Used in debug logging mostly.
    RelayNumbers: [0, 1], // List here relays that are controlled with this script. Shelly relay numbering starts from 0.
    Inverted: false,  // If this is set to 'true', the relay logic is inverted.

    // Location for a temperature forecast. Temperature in use is 24h moving forecasted average temperature.
    PostalCode: "00100", // Postal code (Finland only!). Use value "" if you are outside Finland or want to use coordinates!
    Latitude: "60.169830", // Latitude. Simple service to check the coordinates: www.latlong.net
    Longitude: "24.938190", // Longitude. Simple service to check the coordinates: www.latlong.net

    // Divide day into heating segments to avoid too long gaps between heating
    // For example, if you want to have 4 heating segments per day, each segment is 6 hours long.
    // Heating segments starts at 22:00 and ends at 21:59 the next day. This is to optimize night time heating.
    HeatingSegments_PerDay: 4, // Valid values are 1, 2, 3, 4, 6, 8, 12, 24

    // Minimum time for each heating period. With heat pumps, short heating times may not be efficient.
    MinimumHeatingTime: 45, // Minimum length of one heating time in minutes. Valid values are 15, 30, 45, 60, 90, 120

    // How many percent (%) of the day (22:00-21:59) the heating should be on at different outdoor temperatures.
    // For example, if you want the heating to be on 12 hours per day at 0C, set the percent to 50.
    // System automatically calculates how many MinimumHeatingTime -periods fits into the desired daily heating time.
    HeatingPercentage_Plus30: 0, // Daily heating time percentage at +30C
    HeatingPercentage_Plus20: 5, // Daily heating time percentage at +20C
    HeatingPercentage_Plus10: 20, // Daily heating time percentage at +10C
    HeatingPercentage_Zero: 50, // Daily heating time percentage at 0C
    HeatingPercentage_Minus10: 70, // Daily heating time percentage at -10C
    HeatingPercentage_Minus20: 80, // Daily heating time percentage at -20C
    HeatingPercentage_Minus30: 100, // Daily heating time percentage at -30C

    // Reduce heating by given percentage when the heating segment average price is higher than HeatingReductionPrice.
    // For example: if heating percentage is 50% and reduction percentage is 20%, the new heating percentage will be 40%.
    // Note! average price is is calculated for each heating segment separately!
    HeatingReductionPrice: "average", // Use "average" for daily average price limit or give limit in full euro cents, f.ex. "10".
    HeatingReductionPercentage: 0, // Valid values are 0...100. Set to 0 to disable price based reduction.

    // Price rules
    NightHours: [22, 23, 0, 1, 2, 3, 4, 5, 6], // Night transfer hours. These usually don’t need to be changed (not even during daylight saving time changes).
    PriceDifference: -1.43, // Difference between night and day prices. A negative value means the night transfer is cheaper by this amount. Information available from the electricity distribution company.
    PriceDifference_Months: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], // Modify if price modification is valid only during certain months
    PriceDifference_Days: [1, 2, 3, 4, 5, 6, 7], // Modify if the price modification is valid only during certain days
    PriceAlwaysAllowed: -1.43, // Daytime price that is always allowed. During night hours, prices higher by the amount of the PriceDifference are also allowed.

    // Backup hours
    BackupHours: [1, 2, 3, 4, 12, 13, 16, 17, 21, 22],  // Backup hours (0...23) if internet connection is not working or service is down.

    // Private key. Do not change this value!
    PrivateKey: "<SHF-PrivateKey>" // This is generated by the server, when script is taken through Spot-hinta.fi Shelly script library.
};

// Code starts here - do not change
let url = "https://api.spot-hinta.fi/SmartHeating";
let hour = -1; let nextMessage = new Date(new Date().getTime() + 2 * 60 * 1000); let previousAction = ""; print("SmartHeating: Control starts in 15 seconds.");
let instructions = null; let loadInstructions = true; let instructionsTimeOut = new Date(); let previousStatus = ""; let nextStatusChange = new Date();

Timer.set(15000, true, function () {
    if (loadInstructions == true || instructionsTimeOut < new Date()) { LoadInstructionsFromServer(); PrintSmartHeatingKeyAddressMessage(); }
    else { ChangeRelayStatusIfNeeded(); }

    if (new Date() > nextMessage) {
        nextMessage = new Date(new Date().getTime() + 2 * 60 * 1000);
        print("SmartHeating: Control is running. Relay state: " + previousStatus + " - Next state change: " + nextStatusChange.toString());
    }
});

function ChangeRelayStatusIfNeeded() {
    let relayStatus = GetCurrentlyExpectedRelayStatus();
    if (loadInstructions == true) { print("SmartHeating: New control data must be loaded."); return; }
    if (previousStatus !== relayStatus.result) { SetRelayStatus(relayStatus.result); return; }
}

function SetRelayStatus(newStatus) {
    let invertedStatus = newStatus; if (SETTINGS.Inverted == true) { invertedStatus = !newStatus; }
    previousStatus = newStatus;
    for (let i = 0; i < SETTINGS.RelayNumbers.length; i++) { Shelly.call("Switch.Set", "{ id:" + SETTINGS.RelayNumbers[i] + ", on:" + invertedStatus + "}", null, null); }
    print("SmartHeating: Relay state changed. New state: " + invertedStatus);
}

function LoadInstructionsFromServer() {
    Shelly.call("HTTP.POST", { url: url, body: SETTINGS, timeout: 15, ssl_ca: "*" }, function (res, err) {
        if (err != 0 || res == null || res.code !== 200 || res.body == null) {
            print("SmartHeating: Error fetching control data. Retrying."); ActivateBackupHours();
        } else {
            instructions = JSON.parse(res.body); loadInstructions = false;
            instructionsTimeOut = new Date(instructions.EpochMsExpiration);
            print("SmartHeating: Control data fetched successfully. New data will be fetched by: " + instructionsTimeOut.toString());
        }
    });
}

function GetCurrentlyExpectedRelayStatus() {
    if (instructions == null || instructions.PlanAhead.length == 0) { ActivateBackupHours(); return; }
    const epochMs = Date.now(); if (instructions.PlanAhead[0].epochMs < epochMs) { ActivateBackupHours(); return; }

    for (let i = 0; i < instructions.PlanAhead.length; i++) {
        if (instructions.PlanAhead.length > i && instructions.PlanAhead[i + 1].epochMs > epochMs) { continue; }
        if (instructions.PlanAhead.length > i && instructions.PlanAhead[i + 1].epochMs <= epochMs) { nextStatusChange = new Date(instructions.PlanAhead[i].epochMs); return instructions.PlanAhead[i + 1]; }
        if (instructions.PlanAhead[i].epochMs <= epochMs) { return instructions.PlanAhead[i]; }
    }

    print("SmartHeating: Error situation. No suitable control data found in the list."); ActivateBackupHours();
}

function ActivateBackupHours() {
    loadInstructions = true;
    if (SETTINGS.BackupHours.indexOf(new Date().getHours()) > -1) { print("SmartHeating: Hour now is backup hour."); SetRelayStatus(true); return; }
    else { print("SmartHeating: Hour now is not backup hour."); SetRelayStatus(false); return; }
}

function PrintSmartHeatingKeyAddressMessage() {
    if (SETTINGS.PrivateKey.indexOf("PrivateKey") > -1) {
        print("SmartHeating: To see the current heating plan, please take this script through Spot-hinta.fi Shelly script library.");
    } else {
        print("SmartHeating: To view the current heating plan, please visit the following address:");
        print("SmartHeating: https://api.spot-hinta.fi/SmartHeating?PrivateKey=" + SETTINGS.PrivateKey);
    }
}